# MONE 管理画面ガイド

## アクセス方法

- URL: `/admin`
- ログイン: `/admin/login`
- 認証: メール + パスワード（ADMIN権限が必要）

---

## 認証システム

### 管理者（ADMIN）
- **認証方法**: メールアドレス + パスワード
- **ログイン画面**: `/admin/login`
- **セッション有効期限**: 90日間（アクティブなら1日ごとに延長）

### 顧客（CUSTOMER）
- **認証方法**:
  - LINE ログイン
  - メールマジックリンク（Resend経由）
- **ログイン画面**: `/register`

### 権限チェック
管理画面（`/admin/*`）へのアクセスは ADMIN 権限が必要です。
顧客権限でアクセスすると403エラーが返されます。

---

## 1. ダッシュボード（/admin）

管理画面のホーム画面です。

### 表示内容

| 項目 | 説明 |
|------|------|
| 本日の予約数 | 今日の予約件数 |
| 今週の予約数 | 月曜〜日曜の予約件数（週始まりは月曜） |
| Webからの予約数 | 累計予約件数 |

### 本日の予約タイムライン

- 10:00〜21:00のタイムラインビューで予約を表示
- 各メニューはカテゴリ色で色分け表示
- クリックで予約管理画面へ遷移

### クイックアクション

- キャンセル（×アイコン）: 予約をキャンセル
- 無断キャンセル（時計アイコン）: 無断キャンセルとして記録

---

## 2. 予約管理（/admin/reservations）

予約の一覧確認・編集・新規追加を行います。

### 機能一覧

| 機能 | 説明 |
|------|------|
| カレンダー | 日付を選択して予約をフィルタリング |
| 検索 | 名前・メール・メニューで絞り込み |
| ステータスフィルタ | すべて / 予約確定 / キャンセル / 無断キャンセル |
| 予約追加 | 電話予約を手動登録（顧客選択→メニュー選択→日時選択の3ステップ） |
| 予約編集 | 日時・メニュー・備考の変更、顧客情報の更新 |
| ステータス変更 | キャンセル / 無断キャンセル / 復元 |

### 予約追加フロー

1. **顧客選択**: 既存顧客を検索 or 新規顧客を登録
2. **メニュー選択**: カテゴリごとにメニューを選択（複数選択可）
3. **日時確認**: 日付・開始時間・備考を入力して登録

### 予約ステータス

| ステータス | 説明 |
|-----------|------|
| CONFIRMED | 予約確定 |
| COMPLETED | 来店済み |
| CANCELLED | キャンセル |
| NO_SHOW | 無断キャンセル |

---

## 3. メニュー管理（/admin/menus）

サービスメニューとカテゴリを管理します。

### タブ切り替え

- **メニュー**: 施術メニューの管理
- **カテゴリ**: メニューカテゴリの管理

### メニュー設定項目

| 項目 | 説明 |
|------|------|
| メニュー名 | 表示名 |
| カテゴリ | 所属カテゴリ |
| 価格（税込） | 料金 |
| 所要時間 | 分単位 |
| 価格変動あり | 会計時に金額変更可能にするか |
| 表示順 | 並び順 |
| 有効/無効 | 予約画面に表示するか |

### カテゴリ設定項目

| 項目 | 説明 |
|------|------|
| カテゴリ名 | 日本語名 |
| 英語名 | 英語表記 |
| カラー | 20種のプリセットから選択（カスタムカラーも可） |
| 表示順 | 並び順 |
| 有効/無効 | 表示するか |

### 初期カテゴリ一覧

| カテゴリ名 | 英語名 | カラー |
|-----------|--------|--------|
| カット | Cut | #8B7355 |
| カラー | Color | #9F86C0 |
| パーマ | Perm | #E0B1CB |
| 縮毛矯正 | Straight Perm | #F4A261 |
| スパ＆トリートメント | Spa & Treatment | #2A9D8F |
| シャンプー＆セット | Sp & Set | #98C1D9 |
| メンズシェービング | Men's SV | #ADB5BD |

### 初期メニュー一覧

#### カット
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| カット | ¥4,950 | 40分 |
| カット＋ケアSV | ¥5,500 | 50分 |
| カット＋メンズエステSV | ¥7,150 | 60分 |
| カット＋メンズエステSV〜美顔器エステ〜 | ¥8,800 | 70分 |
| フェードカット | ¥5,500 | 50分 |
| フェードカット＋ケアSV | ¥6,050 | 60分 |
| フェードカット＋メンズエステSV | ¥7,700 | 70分 |
| フェードカット＋メンズエステSV〜美顔器エステ〜 | ¥9,350 | 80分 |
| ジュニア | ¥2,420 | 30分 |
| 小学生 | ¥2,970 | 30分 |
| 中学生 | ¥3,520 | 35分 |
| 高校生 | ¥4,070 | 40分 |

#### カラー
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| カラー | ¥4,950 | 60分 |
| 白髪染 | ¥4,400 | 60分 |
| 白髪ぼかし | ¥3,850 | 45分 |
| ブリーチ | ¥7,150 | 90分 |
| ハイライト・メッシュ | ¥7,150 | 90分 |

#### パーマ
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| ポイントパーマ | ¥4,400 | 60分 |
| デザインパーマ | ¥7,700 | 90分 |
| スパイラルパーマ | ¥7,700 | 90分 |
| ツイスト・波巻き系パーマ | ¥10,450 | 120分 |
| アイロンパーマハーフ | ¥4,400 | 60分 |
| アイロンパーマ | ¥7,700 | 90分 |
| ボリュームダウンパーマ | ¥4,400 | 60分 |

#### 縮毛矯正
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| フロント矯正 | ¥4,400 | 90分 |
| フロント＋サイド | ¥6,600 | 120分 |
| 全頭矯正 | ¥11,000 | 150分 |

#### スパ＆トリートメント
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| もみほぐしクレンジングSPA | ¥2,200 | 30分 |
| 頭皮エイジング予防ヘッドスパ〜皮脂・フケ・ニオイ改善〜 | ¥4,400 | 50分 |
| とろとろスパミルクの頭皮柔らかトリートメントスパ | ¥2,200 | 30分 |
| オーガニックノートシステムトリートメント3step | ¥3,300 | 40分 |
| オーガニックノートシステムトリートメント5step | ¥5,500 | 60分 |
| 魔法のナノバブル | ¥1,100 | 15分 |

#### シャンプー＆セット
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| シャンプーブロー | ¥1,650 | 20分 |
| ヘアセット | ¥1,100 | 15分 |

#### メンズシェービング
| メニュー名 | 価格（税込） | 所要時間 |
|-----------|-------------|---------|
| ケアSV | ¥2,200 | 25分 |
| メンズエステSV | ¥3,850 | 35分 |
| メンズエステSV〜美顔器エステ〜 | ¥5,500 | 45分 |
| ノーズワックス | ¥1,000 | 10分 |

---

## 4. 顧客管理（/admin/customers）

顧客情報と来店履歴を管理します。

### 機能一覧

| 機能 | 説明 |
|------|------|
| 検索 | 名前・メール・電話番号で検索 |
| 新規顧客追加 | 手動で顧客を登録 |
| 顧客編集 | 名前・電話番号・メールの変更 |
| 顧客削除 | 予約履歴ごと削除（確認あり） |
| 来店履歴 | 顧客をクリックで展開、過去の施術履歴を表示 |

### 顧客詳細で確認できる情報

- 累計売上
- 予約総数
- 施術履歴（日時・メニュー・金額・ステータス）

---

## 5. 不定休設定（/admin/holidays）

臨時休業日を設定します。

### 基本仕様

- **定休日**: 月曜日（変更不可）
- **不定休**: カレンダーから任意の日付を選択して追加

### 不定休の設定項目

| 項目 | 説明 |
|------|------|
| 休業タイプ | 終日休業 or 時間帯休業 |
| 開始時間/終了時間 | 時間帯休業の場合 |
| 理由 | 任意（「臨時休業」「研修」など） |

### 操作方法

1. カレンダーの日付をクリック → 不定休を追加
2. 既存の不定休をクリック → 削除確認
3. サイドバーから不定休一覧を確認・削除

---

## 6. 会計・売上管理（POS）（/admin/pos）

会計処理と売上管理を行う本格的なPOSシステムです。

### ダッシュボード統計

| 項目 | 説明 |
|------|------|
| 本日の売上 | 今日の売上金額と件数 |
| 今週の売上 | 月曜〜当日の売上金額 |
| 今月の売上 | 当月1日〜当日の売上金額 |

### サブメニュー

| メニュー | パス | 説明 |
|----------|------|------|
| 新規会計登録 | /admin/pos/sales/new | 新しい会計を作成 |
| 会計履歴 | /admin/pos/sales | 過去の会計一覧・検索 |
| 売上レポート | /admin/pos/reports | レポート・分析 |
| 商品管理 | /admin/pos/products | 店販商品の管理 |
| 割引管理 | /admin/pos/discounts | 店頭割引の設定 |
| クーポン管理 | /admin/pos/coupons | クーポンコードの管理 |
| 設定 | /admin/pos/settings | 税率・支払方法の設定 |

### 支払方法

POS設定画面（/admin/pos/settings）から管理できます。

- 支払方法の追加・削除・編集
- 有効/無効の切り替え
- 表示順の変更（ドラッグ&ドロップ）

---

### 6.1 新規会計登録（/admin/pos/sales/new）

5ステップで会計を登録します。

#### ステップ1: 顧客選択
- 既存顧客を検索して選択
- 新規顧客を登録（名前・電話番号・メール）
- 「顧客なし」で登録も可能

#### ステップ2: メニュー選択
- カテゴリごとにメニューを選択
- 複数メニュー選択可
- 「価格変動あり」のメニューは金額変更可能

#### ステップ3: 商品選択
- 店販商品を追加
- 数量を指定して選択

#### ステップ4: 割引・クーポン適用
- 登録済み割引を適用
- クーポンコードを入力して適用
- 割引額または割引率で計算

#### ステップ5: 支払い・確定
- 支払方法を選択
- 備考を入力（任意）
- 会計を確定

---

### 6.2 会計履歴（/admin/pos/sales）

過去の会計を一覧・検索・管理します。

| 機能 | 説明 |
|------|------|
| 日付フィルタ | 開始日〜終了日で絞り込み |
| ステータスフィルタ | 完了 / キャンセル |
| 検索 | 会計番号・顧客名で検索 |
| 会計詳細 | クリックで詳細画面へ |
| 会計編集 | 金額・メモの修正 |
| 会計キャンセル | 会計を取り消し |

---

### 6.3 売上レポート（/admin/pos/reports）

3種類のレポートを確認できます。

#### 日別レポート
- 日付を選択して当日の売上を確認
- 総売上・会計件数・平均客単価
- 支払方法別グラフ
- 時間帯別売上グラフ
- 当日の会計一覧

#### 月別レポート
- 年月を選択してその月の売上を確認
- 前月比の変化率
- 日別売上推移グラフ
- 曜日別売上グラフ

#### 詳細分析
- 任意の期間を指定して分析
- プリセット期間（7日/30日/90日）
- 日別売上トレンド
- 人気メニュー TOP5
- 人気商品 TOP5
- 支払方法別内訳

---

### 6.4 店販商品管理（/admin/pos/products）

店舗で販売する商品を管理します。

| 項目 | 説明 |
|------|------|
| 商品名 | 表示名 |
| 価格（税込） | 販売価格 |
| 在庫数 | 現在の在庫（任意） |
| 有効/無効 | 会計画面に表示するか |

---

### 6.5 割引管理（/admin/pos/discounts）

会計時に適用できる割引を管理します。

| 項目 | 説明 |
|------|------|
| 割引名 | 表示名（例: 学割、シニア割引） |
| 割引タイプ | 金額割引 or パーセント割引 |
| 割引額/率 | 割引する金額または割引率 |
| 有効/無効 | 使用可能にするか |

---

### 6.6 クーポン管理（/admin/pos/coupons）

クーポンコードを発行・管理します。

| 項目 | 説明 |
|------|------|
| クーポンコード | 入力するコード（例: WELCOME10） |
| クーポン名 | 表示名 |
| 割引タイプ | 金額割引 or パーセント割引 |
| 割引額/率 | 割引する金額または割引率 |
| 有効期限 | 使用可能期間 |
| 使用回数上限 | 全体での使用可能回数 |
| 顧客別使用上限 | 1顧客あたりの使用回数 |
| 有効/無効 | 使用可能にするか |

---

### 6.7 POS設定（/admin/pos/settings）

会計システムの基本設定を行います。

#### 消費税率設定
- 現在の消費税率を表示
- 0〜100%の範囲で設定可能
- 変更後の会計から新税率が適用

#### 支払方法設定
- ドラッグ&ドロップで表示順変更
- 表示名のカスタマイズ
- 有効/無効の切り替え
- 新規支払方法の追加
- 不要な支払方法の削除

---

## 7. Notion連携

NotionをCMSとして使用し、お知らせ・ギャラリー・商品情報を管理します。

### 概要

Notionで以下のコンテンツを管理し、Webサイトに自動反映されます：

| コンテンツ | 用途 | 表示ページ |
|-----------|------|-----------|
| お知らせ（News） | ブログ・ニュース | /news |
| ギャラリー（Gallery） | スタイル写真 | トップページ、/gallery |
| 商品（Products） | 店販商品紹介 | /products |

### 環境変数

```env
# Notion API
NOTION_API_KEY="secret_..."
NOTION_DATABASE_ID_NEWS="..."      # お知らせデータベースID
NOTION_DATABASE_ID_GALLERY="..."   # ギャラリーデータベースID
NOTION_DATABASE_ID_PRODUCTS="..."  # 商品データベースID
NOTION_WEBHOOK_SECRET="..."        # Webhook認証用（任意）
```

---

### 7.1 お知らせ（News）データベース

ブログ・ニュース記事を管理します。

#### 必須プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| タイトル / Title | title | 記事タイトル |
| web公開 / 公開 | checkbox | 公開フラグ（チェックで公開） |

#### 任意プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| ページURL / Slug | rich_text | URLスラッグ（未設定時はページIDを使用） |
| 公開日 / PublishedAt | date | 公開日 |
| 本文 / Excerpt | rich_text | 記事本文・抜粋 |
| カテゴリ / Category | select | 記事カテゴリ |
| サブタイトル / Subtitle | rich_text | サブタイトル |
| サムネイル | files | サムネイル画像（またはページカバーを使用） |
| ステータス | select | 送信ステータス（下書き/送信中/送信済み/送信失敗） |
| 配信先 | multi_select | ニュースレター配信対象 |

#### 記事の公開方法

1. Notionで新規ページを作成
2. タイトル・本文を入力
3. 「web公開」にチェックを入れる
4. 自動的にWebサイトに反映される

---

### 7.2 ギャラリー（Gallery）データベース

スタイル写真を管理します。

#### 必須プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| タイトル | title | スタイル名 |
| 公開 | checkbox | 公開フラグ |
| 画像 | files | スタイル写真 |

#### 任意プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| カテゴリー / カテゴリ | select | スタイルカテゴリ |
| 説明文 | rich_text | スタイルの説明 |
| 画像URL | rich_text | 外部画像URL（画像プロパティの代替） |
| Order | number | 表示順 |

---

### 7.3 商品（Products）データベース

店販商品を管理します。

#### 必須プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| 商品名 / Name | title | 商品名 |
| 公開 | checkbox | 公開フラグ |

#### 任意プロパティ

| プロパティ名 | 型 | 説明 |
|-------------|------|------|
| 価格 / Price | number or rich_text | 価格 |
| 商品カテゴリ / Category | select | 商品カテゴリ |
| 説明文 / Description | rich_text | 商品説明 |
| 画像 | files | 商品画像（またはページカバーを使用） |
| Order | number | 表示順 |

---

### 7.4 ニュースレター配信機能

お知らせをメールで顧客に配信する機能です。

#### 配信先オプション

配信先は「配信先」プロパティ（multi_select）で指定します。

| オプション | 説明 |
|-----------|------|
| すべて | 全顧客に配信 |
| 管理者 | 管理者のみ |
| 新規顧客 | 30日以内に初来店した顧客 |
| リピーター | 2回以上来店した顧客 |
| 最近来店 | 60日以内に来店した顧客 |
| 休眠顧客 | 90日以上来店していない顧客 |
| 予約あり | 今後の予約がある顧客 |
| [カテゴリ名]利用あり | そのカテゴリを利用したことがある顧客 |
| [カテゴリ名]利用なし | そのカテゴリを利用したことがない顧客 |

#### カテゴリ別配信先の自動同期

管理画面でカテゴリを追加・変更すると、Notionの配信先オプションに自動的に「[カテゴリ名]利用あり」「[カテゴリ名]利用なし」が追加されます。

- 同期タイミング: カテゴリ変更時に自動実行
- 削除されたカテゴリのオプションは自動削除

#### ニュースレターの送信方法

1. Notionでお知らせページを作成
2. 「配信先」で対象を選択
3. Notionのボタンオートメーションで `/api/notion-webhook` を呼び出し
4. ステータスが「送信中」→「送信済み」に変更

#### Webhook設定

NotionのボタンオートメーションでWebhookを設定します。

**エンドポイント**: `POST /api/notion-webhook`

**リクエストボディ**:
```json
{
  "pageId": "Notion page ID",
  "secret": "Webhook secret (optional)"
}
```

**ステータス遷移**:
- 下書き → 送信中 → 送信済み
- エラー時: 送信中 → 送信失敗

---

### 7.5 Notion API エンドポイント

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/news` | GET | お知らせ一覧を取得 |
| `/api/news/[slug]` | GET | お知らせ詳細を取得 |
| `/api/gallery` | GET | ギャラリー一覧を取得 |
| `/api/products` | GET | 商品一覧を取得 |
| `/api/notion-webhook` | POST | ニュースレター送信 |
| `/api/admin/sync-newsletter-options` | POST | 配信先オプションを同期 |

---

## 画面遷移図

```
/admin（ダッシュボード）
├── /admin/reservations（予約管理）
├── /admin/menus（メニュー管理）
├── /admin/customers（顧客管理）
├── /admin/holidays（不定休設定）
└── /admin/pos（会計・売上管理）
    ├── /admin/pos/sales/new（新規会計）
    ├── /admin/pos/sales（会計履歴）
    │   └── /admin/pos/sales/[id]（会計詳細）
    │       └── /admin/pos/sales/[id]/edit（会計編集）
    ├── /admin/pos/reports（売上レポート）
    ├── /admin/pos/products（商品管理）
    ├── /admin/pos/discounts（割引管理）
    ├── /admin/pos/coupons（クーポン管理）
    └── /admin/pos/settings（設定）
```

---

## ログアウト

ダッシュボード右上の「ログアウト」ボタンからログアウトできます。
ログアウト後は `/admin/login` にリダイレクトされます。

---

## 関連ファイル

### ページコンポーネント

| ファイル | 説明 |
|---------|------|
| `src/app/(admin)/admin/page.tsx` | ダッシュボード |
| `src/app/(admin)/admin/reservations/page.tsx` | 予約管理 |
| `src/app/(admin)/admin/menus/page.tsx` | メニュー管理 |
| `src/app/(admin)/admin/customers/page.tsx` | 顧客管理 |
| `src/app/(admin)/admin/holidays/page.tsx` | 不定休設定 |
| `src/app/(admin)/admin/pos/page.tsx` | POS ダッシュボード |

### Notion連携

| ファイル | 説明 |
|---------|------|
| `src/lib/notion.ts` | Notion APIクライアント・ヘルパー関数 |
| `src/app/api/news/route.ts` | お知らせAPI |
| `src/app/api/gallery/route.ts` | ギャラリーAPI |
| `src/app/api/products/route.ts` | 商品API |
| `src/app/api/notion-webhook/route.ts` | ニュースレター配信Webhook |

### API エンドポイント（管理画面）

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/admin/reservations` | GET, POST | 予約の取得・作成 |
| `/api/admin/reservations/[id]` | PATCH, DELETE | 予約の更新・削除 |
| `/api/admin/menus` | GET, POST | メニューの取得・作成 |
| `/api/admin/menus/[id]` | PUT, DELETE | メニューの更新・削除 |
| `/api/admin/categories` | GET, POST | カテゴリの取得・作成 |
| `/api/admin/categories/[id]` | PUT, DELETE | カテゴリの更新・削除 |
| `/api/admin/customers` | GET, POST | 顧客の取得・作成 |
| `/api/admin/customers/[id]` | PATCH, DELETE | 顧客の更新・削除 |
| `/api/admin/holidays` | GET, POST | 不定休の取得・作成 |
| `/api/admin/holidays/[id]` | DELETE | 不定休の削除 |
| `/api/admin/sales` | GET, POST | 会計の取得・作成 |
| `/api/admin/sales/[id]` | GET, PATCH, DELETE | 会計の詳細・更新・削除 |
| `/api/admin/products` | GET, POST | 商品の取得・作成 |
| `/api/admin/discounts` | GET, POST | 割引の取得・作成 |
| `/api/admin/coupons` | GET, POST | クーポンの取得・作成 |
| `/api/admin/settings` | GET, POST | 設定の取得・更新 |
| `/api/admin/sync-newsletter-options` | GET, POST | 配信先オプションの同期 |
