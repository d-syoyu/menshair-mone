// prisma/schema.prisma
// MONË - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 認証関連（NextAuth.js）
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  phone         String?
  password      String?   // 管理者用
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  reservations  Reservation[]
  sales         Sale[]              // 顧客の売上履歴
  createdSales  Sale[]   @relation("CreatedSales") // 管理者が作成した売上
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  CUSTOMER
  ADMIN
}

// ============================================
// 予約関連
// ============================================

model Reservation {
  id            String            @id @default(cuid())
  userId        String
  // 予約時に使用したクーポン（会計自動適用用）
  couponId      String?
  couponCode    String?
  couponDiscount Int               @default(0)

  // 集計フィールド（パフォーマンス用に非正規化）
  totalPrice    Int               // 合計金額
  totalDuration Int               // 合計所要時間（分）
  menuSummary   String            // 表示用: "カット + カラー"

  date          DateTime          @db.Date
  startTime     String            // "10:00"
  endTime       String            // "11:30"
  status        ReservationStatus @default(CONFIRMED)
  note          String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon        Coupon?           @relation(fields: [couponId], references: [id])
  items         ReservationItem[]
  sale          Sale?             // この予約の会計

  @@index([date])
  @@index([userId])
  @@index([status])
  @@index([date, status]) // Compound index for reservation queries
  @@index([couponId])
}

// 予約アイテム（複数メニュー対応）
model ReservationItem {
  id            String      @id @default(cuid())
  reservationId String
  menuId        String      // MENU_ITEMS からの ID
  menuName      String      // 予約時点のメニュー名（スナップショット）
  category      String      // カテゴリ（カラーコード表示用）
  price         Int         // 予約時点の価格
  duration      Int         // 予約時点の所要時間（分）
  orderIndex    Int         // 施術順序（0から開始）

  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@unique([reservationId, orderIndex])
}

enum ReservationStatus {
  CONFIRMED   // 確定
  CANCELLED   // キャンセル
  COMPLETED   // 完了
  NO_SHOW     // 無断キャンセル
}

// ============================================
// カテゴリー
// ============================================

model Category {
  id           String   @id @default(cuid())
  name         String   @unique // カテゴリ名（カット、カラー、パーマ等）
  nameEn       String   // 英語名（Cut, Color, Perm等）
  color        String   // カラーコード（#8B7355等）
  displayOrder Int      @default(0) // 表示順
  isActive     Boolean  @default(true) // 有効/無効
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  menus Menu[]

  @@index([isActive])
}

// ============================================
// メニュー
// ============================================

model Menu {
  id              String   @id @default(cuid())
  name            String   // メニュー名
  categoryId      String   // カテゴリID
  price           Int      // 価格
  duration        Int      // 所要時間（分）
  lastBookingTime String   // 最終受付時間 (例: "19:00")
  displayOrder    Int      @default(0) // 表示順
  isActive        Boolean  @default(true) // 有効/無効
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isActive])
}

// ============================================
// お知らせ
// ============================================

model News {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  content     String    @db.Text
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isPublished, publishedAt])
}

// ============================================
// お問い合わせ
// ============================================

model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
}

// ============================================
// 不定休（臨時休業日・時間帯休業）
// ============================================

model Holiday {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  startTime String?  // 開始時間（"10:00"）nullの場合は全日休業
  endTime   String?  // 終了時間（"18:00"）nullの場合は全日休業
  reason    String?  // 休業理由（任意）
  createdAt DateTime @default(now())

  @@unique([date, startTime, endTime])
  @@index([date])
}

// ============================================
// 売上・会計関連（POS）
// ============================================

// 会計（売上）マスタ
model Sale {
  id              String          @id @default(cuid())
  saleNumber      String          @unique // 伝票番号（SALE-YYYYMMDD-XXX）

  // 顧客情報
  userId          String?         // 顧客ID（ウォークイン時は任意）
  customerName    String?         // 顧客名（スナップショット）
  customerPhone   String?         // 顧客電話番号

  // 予約との紐付け
  reservationId   String?         @unique // 予約ID（予約から作成時）

  // 金額情報（内税方式）
  subtotal        Int             // アイテム合計（税込・割引前）
  taxAmount       Int             // 消費税額（totalAmountから逆算）
  taxRate         Int             // 消費税率（%）※スナップショット
  discountAmount  Int             @default(0) // 店頭割引額（税込価格から引く）
  couponId        String?         // 適用クーポンID
  couponDiscount  Int             @default(0) // クーポン割引額（税込価格から引く）
  totalAmount     Int             // 合計金額（税込・割引後）= subtotal - 割引

  // 支払情報
  paymentMethod   String          // 主要支払方法（集計用）
  paymentStatus   PaymentStatus   @default(PENDING)

  // 売上日時
  saleDate        DateTime        @db.Date
  saleTime        String          // "14:30"

  // メモ
  note            String?         @db.Text

  // メタ情報
  createdBy       String?         // 作成者ID（管理者）
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // リレーション
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  reservation     Reservation?    @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  coupon          Coupon?         @relation(fields: [couponId], references: [id], onDelete: SetNull)
  items           SaleItem[]
  payments        Payment[]       // 複数支払対応
  createdByUser   User?           @relation("CreatedSales", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([saleDate])
  @@index([userId])
  @@index([reservationId])
  @@index([couponId])
  @@index([paymentMethod])
  @@index([createdAt])
}

// 会計明細（施術メニュー + 店販商品）
model SaleItem {
  id          String       @id @default(cuid())
  saleId      String

  // アイテム種別
  itemType    SaleItemType // MENU / PRODUCT

  // メニューの場合
  menuId      String?
  menuName    String?
  category    String?
  duration    Int?

  // 店販商品の場合
  productId   String?
  productName String?

  // 共通情報
  quantity    Int          @default(1)
  unitPrice   Int          // 単価
  subtotal    Int          // 小計（数量 × 単価）
  orderIndex  Int          // 明細順序

  sale        Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@unique([saleId, orderIndex])
}

// 支払詳細（複数支払方法対応）
model Payment {
  id            String   @id @default(cuid())
  saleId        String

  paymentMethod String
  amount        Int      // 支払額
  orderIndex    Int      // 支払順序

  note          String?
  createdAt     DateTime @default(now())

  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@unique([saleId, orderIndex])
}

// 店販商品マスタ
model Product {
  id           String          @id @default(cuid())
  name         String          // 商品名
  categoryId   String
  price        Int             // 販売価格（税込）
  cost         Int?            // 原価（任意）
  stock        Int?            // 在庫数（任意・簡易管理）
  code         String?         @unique // 商品コード
  description  String?         @db.Text
  displayOrder Int             @default(0)
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  category     ProductCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isActive])
}

// 店販商品カテゴリ
model ProductCategory {
  id           String    @id @default(cuid())
  name         String    @unique // シャンプー、トリートメント等
  displayOrder Int       @default(0)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  products     Product[]

  @@index([isActive])
}

// 割引マスタ（店頭割引）
model Discount {
  id           String       @id @default(cuid())
  name         String       // 学割、シニア割等
  type         DiscountType // PERCENTAGE / FIXED
  value        Int          // %の場合は整数、固定額の場合は円
  description  String?      @db.Text
  isActive     Boolean      @default(true)
  displayOrder Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([isActive])
}

// クーポンマスタ
model Coupon {
  id                    String        @id @default(cuid())
  code                  String        @unique // クーポンコード（WELCOME10等）
  name                  String        // クーポン名
  type                  DiscountType  // PERCENTAGE / FIXED
  value                 Int           // 割引値
  description           String?       @db.Text

  // 適用条件
  applicableMenuIds     String[]      @default([]) // 特定メニューIDのみ有効（空なら制限なし）
  applicableCategoryIds String[]      @default([]) // 特定カテゴリID/名のみ有効（空なら制限なし）
  applicableWeekdays    Int[]         @default([]) // 0-6（日〜土）に限定（空なら制限なし）
  startTime             String?       // 利用可能開始時刻 "10:00"
  endTime               String?       // 利用可能終了時刻 "20:00"
  onlyFirstTime         Boolean       @default(false) // 初回来店のみ
  onlyReturning         Boolean       @default(false) // リピーターのみ

  // 有効期間
  validFrom             DateTime      // 有効開始日
  validUntil            DateTime      // 有効終了日

  // 利用制限
  usageLimit            Int?          // 全体利用上限（null = 無制限）
  usageLimitPerCustomer Int?          // 顧客ごとの利用上限（null = 無制限）
  usageCount            Int           @default(0) // 現在の利用回数

  // 適用条件
  minimumAmount         Int?          // 最低購入金額（null = 条件なし）

  isActive              Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // リレーション
  usages                CouponUsage[]
  sales                 Sale[]
  reservations          Reservation[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
}

// クーポン利用履歴
model CouponUsage {
  id          String   @id @default(cuid())
  couponId    String
  saleId      String?  @unique // 1つの売上に1つのクーポン
  customerId  String?  // 顧客ID（ログインユーザーの場合）
  usedAt      DateTime @default(now())

  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([customerId])
}

// システム設定（税率等）
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique // "tax_rate"
  value     String   // "10"
  updatedAt DateTime @updatedAt
}

// 支払方法設定
model PaymentMethodSetting {
  id           String   @id @default(cuid())
  code         String   @unique // 支払方法コード（任意の文字列）
  displayName  String   // 表示名（現金、クレジットカード等）
  isActive     Boolean  @default(true) // 有効/無効
  displayOrder Int      @default(0) // 表示順
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([code])
}

// ============================================
// Enum定義（POS用）
// ============================================

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum SaleItemType {
  MENU
  PRODUCT
}

enum DiscountType {
  PERCENTAGE  // パーセンテージ割引
  FIXED       // 固定額割引
}
